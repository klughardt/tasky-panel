version: 2.1
jobs:
  terraform_plan:
    path: 'infrastructure/'
    docker:
    - image: hashicorp/terraform:light
    steps:
    - checkout
    - run:
        name: Initialize Terraform
        command: terraform init
    - run:
        name: Terraform Plan
        command: terraform plan

  terraform_apply:
    path: 'infrastructure/'
    docker:
    - image: hashicorp/terraform:light
    steps:
    - checkout
    - run:
        name: Initialize Terraform
        command: terraform init
    - run:
        name: Terraform Apply
        command: terraform apply -auto-approve

workflows:
  version: 2
  build_and_deploy:
    jobs:
    - terraform_plan
    - terraform_apply:
        requires:
        - terraform_plan
