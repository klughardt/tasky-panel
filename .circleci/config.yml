version: 2.1
jobs:
    terraform_plan:
        docker:
          - image: hashicorp/terraform:light
        steps:
          - checkout
          - run:
                name: Infrastructure Directory
                command: pwd
          - run:
                name: Working Directory
                working_directory: ~/project/infrastructure
                command: pwd
          - run:
                name: Initialize Terraform
                working_directory: ~/project/infrastructure
                command: terraform init
          - run:
                name: Terraform Plan
                working_directory: ~/project/infrastructure
                command: terraform plan

    terraform_apply:
        working_directory: ~/project/infrastructure/
        docker:
          - image: hashicorp/terraform:light
        steps:
          - checkout
          - run:
                name: Infrastructure Directory
                command: cd infrastructure
          - run:
                name: Initialize Terraform
                command: terraform init
          - run:
                name: Terraform Apply
                command: terraform apply -auto-approve

workflows:
    version: 2
    build_and_deploy:
        jobs:
          - terraform_plan
          - terraform_apply:
                requires:
                  - terraform_plan
